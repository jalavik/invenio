# -*- coding: utf-8 -*-
##
## This file is part of Invenio.
## Copyright (C) 2013, 2014 CERN.
##
## Invenio is free software; you can redistribute it and/or
## modify it under the terms of the GNU General Public License as
## published by the Free Software Foundation; either version 2 of the
## License, or (at your option) any later version.
##
## Invenio is distributed in the hope that it will be useful, but
## WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
## General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with Invenio; if not, write to the Free Software Foundation, Inc.,
## 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.


###############################################################################
##########                                                           ##########
##########     Invenio Atlantis Site Bibfield Configuration File     ##########
##########      minimal set for bibliographic records                ##########
##########                                                           ##########
###############################################################################

abstract:
    creator:
        @legacy((("520", "520__", "520__%"), "abstract", ""),
                ("520__a", "abstract", "summary"),
                ("520__b", "expansion"),
                ("520__9", "source"))
        marc, "520__", {'summary':value['a'], 'expansion':value['b'], 'number':value['9']}
    producer:
        json_for_marc(), {"520__a": "summary", "520__b": "expansion", "520__9": "number"}

agency_code:
    creator:
        @legacy(("003", ""), )
        marc, "003", value
    producer:
        json_for_marc(), {"003": ""}
    description:
        """It contains the code for the agency whose system control number is present in field recid"""


first_author, creator:
    creator:
        @legacy((("100", "100__", "100__%"), ""),
                ("100__a", "full_name"),
                ("100__e", "role"),
        ("100__i", "identifier"),
                ("100__u", "affiliation"))
        marc, "100__", { 'full_name':value['a'], 'first_name':util_split(value['a'],',',1), 'last_name':util_split(value['a'],',',0), 'role’:value['e'], ‘identifier’:value['i'], 'affiliation':value['u'] }
    producer:
        json_for_marc(), {"100__a": "full_name", "100__e": “role”, “100__i": “identifier”, "100__u": "affiliation"}

additional_authors, contributor:
    schema:
        {'additional_authors': {'type': 'list', 'force': True}}
    creator:
        @legacy((("700", "700__", "700__%"), ""),
                ("700__a", "full_name"),
                (“700__e", "role"),
        (“700__i", "identifier"),
                ("700__u", "affiliation"))
        @parse_first('first_author')
        marc, "700__", {'full_name': value['a'], 'first_name':util_split(value['a'],',',1), 'last_name':util_split(value['a'],',',0), ‘role’:value['e'], ‘identifier’:value['i'], 'affiliation':value['u'] }
    producer:
        json_for_marc(), {"700__a": "full_name", "700__e": “role”, "700__i": “identifier”, "700__u": "affiliation"}

authors:
    """List with all the authors, connected with first_author and additional_authors"""
    derived:
        @parse_first('first_author', 'additional_authors')
        @connect('first_author', sync_authors)
        @connect('additional_authors', sync_authors)
        @only_if('first_author' in self or 'additional_authors' in self)
        util_merge_fields_info_list(self, ['first_author', 'additional_authors'])


collections:
    schema:
        {'collections': {'type': 'list', 'force': True}}
    creator:
        @legacy((("980", "980__", "980__%"), ""),
                ("980__%", "collection identifier", ""),
                ("980__a", "primary"),
                ("980__b", "secondary"),
                ("980__c", "deleted"))
        marc, "980__", { 'primary':value['a'], 'secondary':value['b'], 'deleted':value['c'] }
    producer:
        json_for_marc(), {"980__a":"primary", "980__b":"secondary", "980__c":"deleted"}


content_type:
    creator:
        @legacy((("336", "336__", "336__%"), ""),
                ("336__a", ""))
        marc, "336__", value['a']
    producer:
        json_for_marc(), {"336__a": ""}
    description:
        """Note: use for SLIDES"""


_first_corporate_name, first_corporate_name:
    creator:
        @legacy((("110", "110__", "110__%"), ""),
                ("110__a", "name"),
                ("110__b", "subordinate_unit"),
                ("110__g", "collaboration"))
        marc, "110__", {'name':value['a'], 'subordinate_unit':value['b'], 'collaboration':value['g']}
    producer:
        json_for_marc(), {"110__a":"name", "110__b":"subordinate_unit", "110__":"collaboration"}


_additional_corporate_names, additional_corporate_names:
    schema:
        {'_additional_corporate_names': {'type': 'list', 'force': True}}
    creator:
        @legacy((("710", "710__", "710__%"), ""),
                ("710__a", "name"),
                ("710__b", "subordinate_unit"),
                ("710__g", "collaboration", "collaboration"))
        marc, "710__", {'name':value['a'], 'subordinate_unit':value['b'], 'collaboration':value['g']}
    producer:
        json_for_marc(), {"710__a":"name", "710__b":"subordinate_unit", "710__":"collaboration"}


copyright:
    creator:
        @legacy((("542", "542__", "542__%"), ""),
                ("542__d", "holder"),
                ("542__g", "date"),
                ("542__u", "url"),
                ("542__e", "holder_contact"),
                ("542__f", "statement"),
                ("542__3", "materials"),)
        marc, "542__", {'holder':value['d'], 'date':value['g'], 'url':value['u'], 'holder_contact':value['e'], 'statement':value['f'], 'materials':value['3']}
    producer:
        json_for_marc(), {"542__d": "holder", "542__g": "date", "542__u": "url", "542__e": "holder_contact", "542__f": "statement", "542__3": "materials"}


corporate_names:
    derived:
        @parse_first('_first_corporate_name', '_additional_corporate_names')
        @connect('_first_corporate_name', sync_corparate_names)
        @connect('_additional_corporate_names', sync_corparate_names)
        @only_if('_first_corporate_name' in self or '_additional_corporate_names' in self)
        util_merge_fields_info_list(self, ['_first_corporate_name', '_additional_corporate_names'])


dewey_decimal_classification_number:
    creator:
        @legacy((("082", "082__", "082__%"), ""),
                ("082__a", ""))
        marc, "082__", value['a']
    producer:
        json_for_marc(), {"082__a": ""}


edition_statement:
    creator:
        @legacy((("250", "250__", "250__%"), ""),
                ("250__a", ""))
        marc, "250__", value['a']
    producer:
        json_for_marc(), {"250__a": ""}
    description:
        """Information relating to the edition of a work as determined by applicable cataloging rules."""


fft:
    creator:
        @legacy((('FFT', 'FFT__', 'FFT__%'), ''),
                ("FFT__a", "path"),
                ("FFT__d", "description"),
                ("FFT__f", "eformat"),
                ("FFT__i", "temporary_id"),
                ("FFT__m", "new_name"),
                ("FFT__n", "name"),
                ("FFT__o", "flag"),
                ("FFT__r", "restriction"),
                ("FFT__s", "timestamp"),
                ("FFT__t", "docfile_type"),
                ("FFT__v", "version"),
                ("FFT__x", "icon_path"),
                ("FFT__z", "comment"),
                ("FFT__w", "document_moreinfo"),
                ("FFT__p", "version_moreinfo"),
                ("FFT__b", "version_format_moreinfo"),
                ("FFT__f", "format_moreinfo"))
        marc, "FFT__", {'path': value['a'],
                        'description': value['d'],
                        'eformat': value['f'],
                        'temporary_id': value['i'],
                        'new_name': value['m'],
                        'flag': value['o'],
                        'restriction': value['r'],
                        'timestamp': value['s'],
                        'docfile_type': value['t'],
                        'version': value['v'],
                        'icon_path': value['x'],
                        'comment': value['z'],
                        'document_moreinfo': value['w'],
                        'version_moreinfo': value['p'],
                        'version_format_moreinfo': value['b'],
                        'format_moreinfo': value['u']
                       }
        @only_if_master_value(is_local_url(value['u']))
        marc, "8564_", {'hots_name': value['a'],
                        'access_number': value['b'],
                        'compression_information': value['c'],
                        'path':value['d'],
                        'electronic_name': value['f'],
                        'request_processor': value['h'],
                        'institution': value['i'],
                        'formart': value['q'],
                        'settings': value['r'],
                        'file_size': value['s'],
                        'url': value['u'],
                        'subformat':value['x'],
                        'description':value['y'],
                        'comment':value['z']}
    producer:
        json_for_marc(), {"FFT__a": "path", "FFT__d": "description", "FFT__f": "eformat", "FFT__i": "temporary_id", "FFT__m": "new_name", "FFT__o": "flag", "FFT__r": "restriction", "FFT__s": "timestamp", "FFT__t": "docfile_type", "FFT__v": "version", "FFT__x": "icon_path", "FFT__z": "comment", "FFT__w": "document_moreinfo", "FFT__p": "version_moreinfo", "FFT__b": "version_format_moreinfo", "FFT__f": "format_moreinfo"}

funding_info:
    creator:
        @legacy((("536", "536__", "536__%"), ""),
                ("536__a", "agency"),
                ("536__c", "grant_number"),
                ("536__f", "project_number"),
                ("536__r", "access_info"))
        marc, "536__", {'agency':value['a'], 'grant_number':value['c'], 'project_number':value['f'], 'access_info':value['r']}
    producer:
        json_for_marc(), {"536__a": "agency", "536__c": "grant_number", "536__f": "project_number", "536__r": "access_info"}


imprint:
    creator:
        @legacy((("260", "260__", "260__%"), ""),
                ("260__a", "place"),
                ("260__b", "publisher"),
                ("260__c", "date"),
                ("260__g", "reprinted_editions"))
        marc, "260__", {'place':value['a'], 'publisher':value['b'], 'date':value['c'], 'reprinted_editions':value['g']}
    producer:
        json_for_marc(), {"260__a": "place", "260__b": "publisher", "260__c": "date", "260__g": "reprinted_editions"}



instrument:
    creator:
        @legacy((("693", "693__", "693__%"), ""),
                ("693__a", "accelerator"),
                ("693__e", "experiment"),
                ("693__f", "facility"))
        marc, "693__", {'accelerator':value['a'], 'experiment':value['e'], 'facility':value['f']}
    producer:
        json_for_marc(), {"693__a": "accelerator", "693__b": "experiment", "693__f": "facility"}


internal_note:
    creator:
        @legacy((("595", "595__", "595__%"), ""),
                ("595__a", ""))
        marc, "595__", {'':value['a']}
    producer:
        json_for_marc(), {"595__a": ""}

isbn:
    creator:
        @legacy((("020", "020__", "020__%"), ""),
                ("020__a", “value”),
                ("020__u", “material_type”))
        marc, "020__", {‘value’:value['a'], ‘material_type’:value['u']}
    producer:
        json_for_marc(), {"020__a": “value”, "020__u": “material_type”}

isn:
    creator:
        @legacy((("021", "021__", "021__%"), ""),
                ("021__a", “))
        marc, "021__", value['a']
    producer:
        json_for_marc(), {"021__a": ""}

issn:
    creator:
        @legacy((("022", "022__", "022__%"), ""),
                ("022__a", "issn", ""))
        marc, "022__", value['a']
    producer:
        json_for_marc(), {"022__a": ""}


keywords:
    schema:
        {'keywords': {'type': 'list', 'force': True}}
    creator:
        @legacy((("653", "6531_", "6531_%"), ""),
                ("6531_a", "keyword", "term"),
                ("6531_9", "institute"))
        marc, "6531_", { 'term': value['a'], 'institute': value['9'] }
    producer:
        json_for_marc(), {"6531_a": "term", "6531_9": "institute"}



language:
    creator:
        @legacy((("041", "041__", "041__%"), ""),
                ("041__a", ""))
        marc, "041__", value['a']
    producer:
        json_for_marc(), {"041__a": ""}


library_of_congress_call_number:
    creator:
        @legacy((("050", "050__", "050__%"), ""),
                ("050__a", "classification_number"),
                ("050__b", "item_number"))
        marc, "050__", {'classification_number':value['a'], 'item_number':value['b']}
    producer:
        json_for_marc(), {"050__a": "classification_number", "050__b": "item_number"}

license:
    creator:
        @legacy((("540", "540__", "540__%"), ""),
                ("540__a", "license"),
                ("540__b", "imposing"),
                ("540__u", "url"),
                ("540__3", "material"))
        marc, "540__", {'license':value['a'], 'imposing':value['b'], 'url':value['u'], 'material':value['3'],}
    producer:
        json_for_marc(), {"540__a": "license", "540__b": "imposing", "540__u": "url", "540__3": "material"}



note:
    creator:
        @legacy((("500", "500__", "500__%"), ""),
                ("500__a", ""),
                ("500__9", "source",))
        marc, "500__", {value['a'], 'source':value['9']}
    producer:
        json_for_marc(), {"500__a": "", 500__9": "source"}


@persistent_identifier(4)
oai:
    creator:
        @legacy((("024", "0248_", "0248_%"), ""),
                ("0248_a", "oai"),
                ("0248_p", "indicator"))
        marc, "0248_", {'value': value['a'], 'indicator': value['p']}
    producer:
        json_for_marc(), {"0248_a": "oai", "0248_p": "indicator"}


other_report_number:
    creator:
        @legacy((("084", "084__", "084__%"), ""),
                ("084__a", "clasification_number"),
                ("084__b", "collection_short"),
                ("084__2", "source_number"))
        marc, "084__", {'clasification_number':value['a'], 'collection_short':value['b'], 'source_number':value['2'],}
    producer:
        json_for_marc(), {"084__a": "clasification_number", "084__b": "collection_short", "084__2": "source_number"}

physical_description:
    creator:
        @legacy((("300", "300__", "300__%", "")),
                ("300__a", “number_pages”),
        marc, "300__", {‘number_pages’:value['a']}
    producer:
        json_for_marc(), {"300__a": “number_pages”}


prepublication:
    creator:
        @legacy((("269", "269__", "269__%"), ""),
                ("269__a", "place"),
                ("269__b", "publisher_name"),
                ("269__c", "date"))
        marc, "269__", {'place':value['a'], 'publisher_name': value['b'], 'date':value['c']}
    producer:
        json_for_marc(), {"269__a": "place", "269__b": "publisher_name", "269__c": "date"}
    description:
        """
        note: don't use for theses
        """

primary_report_number:
    creator:
        @legacy((("037", "037__", "037__%"), ""),
                ("037__a", "primary report number", ""), )
        marc, "037__", value['a']
    producer:
        json_for_marc(), {"037__a": ""}



publication_info:
    creator:
        @legacy((("773", "773__", "773__%"), ""),
                ("773__0”, “parent_record_id”),
                ("773__c", "page_range”, "article_id),
                ("773__r”, "reportnumber”),
                ("773__n”, “issue”),
                ("773__p", “periodical"),
                ("773__v", "volume"),
                ("773__y", "year"),
                ("773__z”, “ISBN”),
                ("773__x", “unformatted”))
        marc, "773__", {‘parent_record_id’:value[‘0’], 'page_range’:value['c'], ‘reportnumber’:value[‘r’], ‘issue’:value[’n’], ‘periodical':value['p'], 'volume':value['v'], 'year':value['y'], ‘ISBN’:value[‘z’], unformatted’:value['x']}
    producer:
        json_for_marc(), {"773__0”: “parent_record_id”, "773__c": "page_range”, "773__r”: “reportnumber”, "773__n”: “issue”, "773__p": “periodical”, "773__v": "volume", "773__y": "year", "773__z”: “ISBN”, "773__x": “unformatted”}

reference:
    creator:
        @legacy((("999", "999C5", "999C5%"), ""),
                ("999C5", "reference", ""),
                ("999C5a", "persistent_id"),
                ("999C5h", "authors"),
                ("999C5m", "misc"),
                ("999C5n", "issue_number"),
                ("999C5o", "number"),
                ("999C5p", "publisher"),
                ("999C5r", "report_number"),
                ("999C5s", "journal_pubnote"),
                ("999C5u", "url"),
                ("999C5y", "year"),)
        marc, "999C5", {'persistent_id':value['a'], 'authors':value['h'], 'misc':value['m'], 'issue_number':value['n'], 'number':value['o'], 'publisher':value['p'], 'report_number':value['r'], 'journal_pubnote':value['s'], 'url':value['u'], 'year':value['y'],}
    producer:
        json_for_marc(), {"999C5a": "persistent_id", "999C5h": "authors", "999C5m": "misc", "999C5n": "issue_number", "999C5o":"number", "999C5p":"publisher", "999C5r":"report_number", "999C5s":"journal_pubnote", "999C5u":"url", "999C5y": "year"}


report_number:
    creator:
        @legacy((("088", "088__", "088__%"), ""),
                ("088__a", ""),
                ("088__9", "internal"))
        marc, "088__", {'':value['a'], 'internal':value['9']}
    producer:
        json_for_marc(), {"088__a": "", "088__9": "internal"}


series:
    creator:
        @legacy((("490", "490__", "490__%"), ""),
                ("490__a", “title”),
                ("490__v", "volume"))
        marc, "490__", {‘title’:value['a'], 'volume':value['v']}
    producer:
        json_for_marc(), {"490__a": “title”, "490__v": "volume"}


subject:
    creator:
        @legacy((("650", "65017", "65017%"), ""),
                ("65017a", "term"),
                ("650172", "schema”),
                ("650179”, “source”))
        marc, "65017", {'term':value['a'], 'source':value[‘9’], ‘schema’:value[‘2’]}
    producer:
        json_for_marc(), {"65017a": "term", "650172": “schema”, "650179”: “source”}

subject_additional:
    creator:
        @legacy((("650", "65027", "65027%"), ""),
                ("65027a", "additional subject", "term"),
                ("650272", "source"),
                ("65027e", "relator"),
                ("65027p", "percentage"))
        marc, "65027", {'term':value['a'], 'source':value['2'], 'relator':value['e'], 'percentage':value['p']}
    producer:
        json_for_marc(), {"65027a": "term", "650272": "source", "65027e": "relator", "65027p": "percentage"}




@persistent_identifier(3)
standard_identifier:
    creator:
        @legacy((("024", "0247_", "0247_%"), ""),
                ("0247_a", “value”),
                ("0247_2”, “schema”))
        marc, "0247_", {‘value’: value[‘a’], ‘schema’: value[‘2’]}
    producer:
        json_for_marc(), {'0247_2': 'schema’, '0247_a': ‘value’}


@persistent_identifier(2)
system_control_number:
    creator:
        @legacy((("035", "035__", "035__%"), ""),
                ("035__a", “value”),
                ("035__z”, "superseded”),
                ("035__9", “organisation”))
        marc, "035__", {'value': value['a'], ‘superseded’:value['z'], ‘organisation’:value['9']}
    producer:
        json_for_marc(), {"035__a": “value”, "035__z”: “superseded”, "035__9": “organisation”}



thesis:
    creator:
        @legacy((("502", "502__", "502__%"), ""),
                ("502__b”,”type”),
                ("502__c”,”university"),
                ("502__d”,”date"))
        marc, "502__", {‘type’:value[‘b’], 'university':value[‘c’], 'date':value[‘d’]}
    producer:
        json_for_marc(), {"502__b”: “type”, "502__c”: "university", "502__d”: "date"}


abbreviated_title:
    creator:
        @legacy((("210", "210__", "210__%"), ""),
                ("210__a", ""))
        marc, "210__", value['a']
    producer:
        json_for_marc(), {"210__a": ""}

title:
    creator:
        @legacy(((“245", “245__", “245__%"), ""),
                (“245__a", “main”),
                (“245__b", "subtitle"),)
        marc, “245__", {‘main’:value['a'], 'subtitle':value['b']}
    producer:
        json_for_marc(), {“245__a": “main”, “245__b": "subtitle"}

title_variant:
    creator:
        @legacy((("246", "246__", "246__%"), ""),
                ("246__%", "title variant”, ""),
                ("246__a", “main”),
                ("246__b", "subtitle”))
        marc, "246__", { ‘main’:value['a'], 'subtitle':value['b']}
    producer:
        json_for_marc(), {"246__a": “main”, "246__b": "subtitle"}



title_old:
    creator:
        @legacy((("247”, "247__”, "247__%”), ""),
                ("247__a”, “main”),
                ("246__b”, “subtitle”))
        marc, "247__”, { ‘main’:value['a'], ‘subtitle’:value[‘b’]}
    producer:
        json_for_marc(), {"247__a”: “main”, "247__b”: “subtitle”}


title_translation:
    creator:
        @legacy((("242", "242__", "242__%"), ""),
                ("242__a", “main”),
                ("242__b", "subtitle"))
        marc, "242__", {‘main’:value['a'], 'subtitle':value['b']}
    producer:
        json_for_marc(), {"242__a": “main”, "242__b": "subtitle"}


udc:
    creator:
        @legacy((("080", "080__", "080__%"), ""),
                ("080__a", ""))
        marc, "080__", value['a']
    producer:
        json_for_marc(), {"080__a": ""}
    description:
       """"universal decimal classification number"""

url:
    creator:
        @legacy((("856", "8564_", "8564_%"), ""),
                ("8564_a", "host_name"),
                ("8564_b", "access_number"),
                ("8564_c", "compression_information"),
                ("8564_d", "path"),
                ("8564_f", "electronic_name"),
                ("8564_h", "request_processor"),
                ("8564_i", "institution"),
                ("8564_q", "eformat"),
                ("8564_r", "settings"),
                ("8564_s", "file_size"),
                ("8564_u", "url", "url"),
                ("8564_x", "subformat"),
                ("8564_y", "caption", "description"),
                ("8564_z", "comment"))
        @only_if_master_value(not is_local_url(value['u']))
        marc, "8564_", {'host_name': value['a'],
                        'access_number': value['b'],
                        'compression_information': value['c'],
                        'path':value['d'],
                        'electronic_name': value['f'],
                        'request_processor': value['h'],
                        'institution': value['i'],
                        'eformart': value['q'],
                        'settings': value['r'],
                        'size': value['s'],
                        'url': value['u'],
                        'subformat':value['x'],
                        'description':value['y'],
                        'comment':value['z']}
    producer:
        json_for_marc(), {"8564_a": "host_name", "8564_b": "access_number", "8564_c": "compression_information", "8564_d": "path", "8564_f": "electronic_name", "8564_h": "request_processor", "8564_i": "institution", "8564_q": "eformat", "8564_r": "settings", "8564_s": "file_size", "8564_u": "url", "8564_x": "subformat", "8564_y": "description", "8564_z": "comment"}



###############################################################################
##########                                                           ##########
##########       Derived and Calculated Fields Definitions           ##########
##########                                                           ##########
###############################################################################

files:
    calculated:
         @legacy('marc', ("8564_z", "comment"),
                         ("8564_y", "caption", "description"),
                         ("8564_q", "eformat"),
                         ("8564_f", "name"),
                         ("8564_s", "size"),
                         ("8564_u", "url", "url")
                )
        @parse_first('recid')
        @memoize()
        get_files_from_bibdoc(self.get('recid', -1))
    producer:
        json_for_marc(), {"8564_z": "comment", "8564_y": "description", "8564_q": "eformat", "8564_f": "name", "8564_s": "size", "8564_u": "url"}
    description:
        """
        Retrieves all the files related with the recid that were passed to the system
        using the FFT field described above

        Note: this is a mandatory field and it shouldn't be remove from this configuration
        file. On the other hand the function that retrieve the metadata from BibDoc could
        be enrich.
        """

number_of_authors:
    """Number of authors"""
    derived:
        @depends_on('authors')
        len(self['authors'])

number_of_copies:
    calculated:
        @depends_on('recid', 'collections')
        @only_if('BOOK' in self.get('collections.primary', []))
        @memoize()
        get_number_of_copies(self['recid'])
    description:
        """Number of copies"""

number_of_reviews:
    calculated:
        @parse_first('recid')
        @memoize()
        get_number_of_reviews(self.get('recid'))
    description:
        """Number of reviews"""

number_of_comments:
    calculated:
        @parse_first('recid')
        @memoize(30)
        get_number_of_comments(self.get('recid'))
    description:
        """Number of comments"""

cited_by_count:
    calculated:
        @parse_first('recid')
        @memoize()
        get_cited_by_count(self.get('recid'))
    description:
        """How many records cite given record"""
